<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>La NutrIA - Chatbot Nutricional</title>
<style>
  body, html {
    height: 100%;
    margin: 0;
    font-family: Arial, sans-serif;
    background: #e9f5ef;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #chat-container {
    width: 100%;
    max-width: 600px;
    height: 90vh;
    background: white;
    border-radius: 15px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  }
  #chat-header {
    background-color: #43a047;
    color: white;
    padding: 15px;
    border-radius: 15px 15px 0 0;
    font-size: 1.5em;
    font-weight: bold;
    text-align: center;
  }
  #chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: #f5faf6;
  }
  .message {
    margin-bottom: 15px;
    max-width: 80%;
    padding: 10px 15px;
    border-radius: 20px;
    line-height: 1.3em;
    word-wrap: break-word;
  }
  .user {
    background-color: #a5d6a7;
    color: #1b5e20;
    align-self: flex-end;
    border-bottom-right-radius: 0;
  }
  .bot {
    background-color: #c8e6c9;
    color: #2e7d32;
    align-self: flex-start;
    border-bottom-left-radius: 0;
  }
  #input-area {
    display: flex;
    padding: 10px 15px;
    border-top: 1px solid #ddd;
    background: white;
    border-radius: 0 0 15px 15px;
  }
  #input-area input {
    flex: 1;
    padding: 10px 15px;
    border: 1px solid #ccc;
    border-radius: 20px;
    font-size: 1em;
  }
  #input-area button {
    margin-left: 10px;
    padding: 10px 20px;
    background-color: #43a047;
    border: none;
    border-radius: 20px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #input-area button:hover {
    background-color: #388e3c;
  }
</style>
</head>
<body>

<div id="chat-container">
  <div id="chat-header">La NutrIA ðŸ¤–</div>
  <div id="chat-messages"></div>
  <form id="input-area">
    <input type="text" id="user-input" autocomplete="off" placeholder="Escribe tu mensaje aquÃ­..." required />
    <button type="submit">Enviar</button>
  </form>
</div>

<script>
  const chatMessages = document.getElementById("chat-messages");
  const inputForm = document.getElementById("input-area");
  const userInput = document.getElementById("user-input");

  // AquÃ­ pon tu API key (Â¡NO compartas esta pÃ¡gina pÃºblicamente con la key!)
  const OPENAI_API_KEY = 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;

  // Prompt fijo con la instrucciÃ³n principal
  const systemPrompt = `
Eres NutriBot, un experto en nutriciÃ³n y alimentaciÃ³n saludable. SOLO respondes preguntas relacionadas con nutriciÃ³n. Si alguien pregunta sobre medicina, psicologÃ­a, ejercicio, tecnologÃ­a u otro tema, amablemente rediriges la conversaciÃ³n hacia temas nutricionales.

Hablas SIEMPRE en espaÃ±ol, con un tono amable, respetuoso y profesional. Tu objetivo es dar informaciÃ³n Ãºtil, clara, basada en evidencia cientÃ­fica, sin juzgar y adaptada a cada persona.

Cuando un usuario inicia por primera vez, pÃ­dele estos datos de manera opcional (puede responder solo algunos si quiere):

- Nombre  
- Edad  
- GÃ©nero  
- Peso (en kg)  
- Estatura (en cm)  
- Nivel de actividad fÃ­sica (sedentario, ligera, moderada, intensa)  
- Objetivo principal (bajar de peso, mantener, subir masa muscular, comer mÃ¡s sano, etc.)

DespuÃ©s de obtener esa informaciÃ³n, ofrece una guÃ­a general de lo que la persona debe hacer: hÃ¡bitos alimenticios recomendados, consejos, y valores aproximados de calorÃ­as o macros si aplica. SÃ© siempre claro que esto es solo una orientaciÃ³n, no un plan mÃ©dico personalizado.

AdemÃ¡s:

- Puedes ayudar a crear planes de comida semanales (meal plans), menÃºs diarios o ideas para meal prep.
- Puedes dar recetas simples, ejemplos de desayunos, almuerzos y cenas saludables segÃºn el perfil de la persona.
- Explica por quÃ© haces ciertas recomendaciones (por ejemplo, por quÃ© es buena la fibra o por quÃ© reducir azÃºcares).
- Siempre recuerda al usuario que lo ideal es consultar a un nutricionista presencial para un plan completamente adaptado.

Empieza cada respuesta con una frase positiva o alentadora como:  
"Â¡Con gusto te ayudo!", "QuÃ© bueno que te estÃ¡s cuidando", o "Vamos paso a paso para lograr tus objetivos."
`;

  let conversation = [
    { role: "system", content: systemPrompt }
  ];

  function appendMessage(text, sender) {
    const div = document.createElement("div");
    div.classList.add("message");
    div.classList.add(sender);
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Guardar la conversaciÃ³n completa en localStorage
    // Solo guardamos mensajes de usuario y asistente, no system
    if (sender === "user" || sender === "bot") {
      localStorage.setItem("laNutrIAConversation", JSON.stringify(conversation));
    }
  }

  function loadConversation() {
    const saved = localStorage.getItem("laNutrIAConversation");
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (Array.isArray(parsed)) {
          conversation = parsed;
          conversation.forEach(msg => {
            const sender = msg.role === "user" ? "user" : (msg.role === "assistant" ? "bot" : null);
            if (sender) appendMessage(msg.content, sender);
          });
        }
      } catch {
        // No pasa nada si no se puede parsear
      }
    } else {
      // Si no hay historial, mostrar mensaje inicial
      appendMessage(`Â¡Hola! Soy La NutrIA ðŸ¤–, tu asistente de nutriciÃ³n. Â¿En quÃ© puedo ayudarte hoy?`, "bot");
    }
  }

  inputForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const inputText = userInput.value.trim();
    if (!inputText) return;

    appendMessage(inputText, "user");
    userInput.value = "";

    conversation.push({ role: "user", content: inputText });

    appendMessage("La NutrIA estÃ¡ escribiendo...", "bot");

    try {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${OPENAI_API_KEY}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: conversation,
          temperature: 0.7,
          max_tokens: 1000,
          n: 1,
          stop: null
        })
      });

      const data = await response.json();
      const botMessage = data.choices[0].message.content;

      // Reemplazar el "estÃ¡ escribiendo"
      const typingDivs = document.querySelectorAll(".bot");
      typingDivs[typingDivs.length - 1].textContent = botMessage;

      conversation.push({ role: "assistant", content: botMessage });

    } catch (error) {
      console.error(error);
      const typingDivs = document.querySelectorAll(".bot");
      typingDivs[typingDivs.length - 1].textContent = "Error al obtener respuesta. Intenta mÃ¡s tarde.";
    }
  });

  window.onload = () => {
    loadConversation();
  };
</script>

</body>
</html>
